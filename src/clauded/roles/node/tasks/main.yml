---
# Install Node.js from Alpine packages (native musl binaries)
# Official Node.js binaries are compiled against glibc and don't work on Alpine/musl

- name: Remove any previous Node.js installation
  file:
    path: "{{ item }}"
    state: absent
  loop:
    - /opt/fnm
    - /usr/local/bin/fnm
    - /opt/node
  ignore_errors: yes

- name: Install Node.js from Alpine packages
  apk:
    name:
      - nodejs
      - npm
    state: present
    update_cache: yes

- name: Verify Node.js installation
  command: node --version
  register: node_version_output
  changed_when: false

- name: Display Node.js version
  debug:
    msg: "Node.js version: {{ node_version_output.stdout }}"

# Enable corepack for yarn/pnpm version management
- name: Enable corepack
  command: corepack enable
  changed_when: false
  ignore_errors: yes

# Install bun
- name: Install bun dependencies
  apk:
    name:
      - unzip
      - curl
      - gcompat
    state: present

- name: Create bun installation directory
  file:
    path: /opt/bun/bin
    state: directory
    mode: '0755'

- name: Download bun binary
  get_url:
    url: "{{ downloads.bun.binary['linux-aarch64'].url }}"
    dest: /tmp/bun.zip
    mode: '0644'

- name: Extract bun binary
  unarchive:
    src: /tmp/bun.zip
    dest: /tmp
    remote_src: yes

- name: Install bun binary
  copy:
    src: /tmp/bun-linux-aarch64/bun
    dest: /opt/bun/bin/bun
    mode: '0755'
    remote_src: yes

- name: Clean up bun download artifacts
  file:
    path: "{{ item }}"
    state: absent
  loop:
    - /tmp/bun.zip
    - /tmp/bun-linux-aarch64

- name: Create bun symlink
  file:
    src: /opt/bun/bin/bun
    dest: /usr/local/bin/bun
    state: link
    force: yes

- name: Create bunx symlink (bun provides bunx as an alias)
  file:
    src: /opt/bun/bin/bun
    dest: /usr/local/bin/bunx
    state: link
    force: yes
