---
# Use nodejs-current from community which is built against compatible sqlite

- name: Remove any previous fnm installation
  file:
    path: "{{ item }}"
    state: absent
  loop:
    - /opt/fnm
    - /usr/local/bin/fnm
    - /usr/local/bin/node
    - /usr/local/bin/npm
    - /usr/local/bin/npx
  ignore_errors: yes

- name: Enable Alpine v3.21 community repository
  lineinfile:
    path: /etc/apk/repositories
    line: "https://dl-cdn.alpinelinux.org/alpine/v3.21/community"
    state: present

- name: Update apk cache
  apk:
    update_cache: yes

- name: Install nodejs-current and npm (has compatible sqlite)
  apk:
    name:
      - nodejs-current
      - npm
    state: present

- name: Verify Node.js installation
  command: node --version
  register: node_version_output
  changed_when: false

- name: Display Node.js version
  debug:
    msg: "Node.js version: {{ node_version_output.stdout }}"

# Enable corepack for yarn/pnpm version management
- name: Enable corepack
  command: corepack enable
  changed_when: false
  ignore_errors: yes

# Install bun with integrity verification
- name: Install bun dependencies
  apk:
    name:
      - unzip
      - curl
      - gcompat
    state: present

- name: Create bun installation directory
  file:
    path: /opt/bun/bin
    state: directory
    mode: '0755'

- name: Download bun binary with integrity verification
  get_url:
    url: "{{ downloads.bun.binary['linux-aarch64'].url }}"
    dest: /tmp/bun.zip
    mode: '0644'
    checksum: "sha256:{{ downloads.bun.binary['linux-aarch64'].sha256 }}"

- name: Extract bun binary
  unarchive:
    src: /tmp/bun.zip
    dest: /tmp
    remote_src: yes

- name: Install bun binary
  copy:
    src: /tmp/bun-linux-aarch64/bun
    dest: /opt/bun/bin/bun
    mode: '0755'
    remote_src: yes

- name: Clean up bun download artifacts
  file:
    path: "{{ item }}"
    state: absent
  loop:
    - /tmp/bun.zip
    - /tmp/bun-linux-aarch64

- name: Create bun symlink
  file:
    src: /opt/bun/bin/bun
    dest: /usr/local/bin/bun
    state: link
    force: yes

- name: Create bunx symlink (bun provides bunx as an alias)
  file:
    src: /opt/bun/bin/bun
    dest: /usr/local/bin/bunx
    state: link
    force: yes
