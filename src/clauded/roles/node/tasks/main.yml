---
# Install Node.js from official binaries with version pinning and integrity verification

- name: Remove any previous Node.js installation
  file:
    path: "{{ item }}"
    state: absent
  loop:
    - /opt/fnm
    - /usr/local/bin/fnm
    - /opt/node
    - /usr/local/bin/node
    - /usr/local/bin/npm
    - /usr/local/bin/npx
    - /usr/local/bin/corepack
  ignore_errors: yes

- name: Install Node.js dependencies
  apk:
    name:
      - curl
      - libstdc++
    state: present
    update_cache: yes

- name: Set Node.js download metadata
  set_fact:
    node_download: "{{ downloads.node.versions[node_version] | default(downloads.node.versions[downloads.node.default_version]) }}"
    node_effective_version: "{{ node_version if node_version in downloads.node.versions else downloads.node.default_version }}"

- name: Download Node.js {{ node_download.version }}
  get_url:
    url: "{{ node_download.url }}"
    dest: /tmp/node.tar.gz
    mode: '0644'
    checksum: "sha256:{{ node_download.sha256 }}"

- name: Create Node.js installation directory
  file:
    path: /opt/node
    state: directory
    mode: '0755'

- name: Extract Node.js
  unarchive:
    src: /tmp/node.tar.gz
    dest: /opt/node
    remote_src: yes
    extra_opts:
      - --strip-components=1

- name: Create symlinks for Node.js binaries
  file:
    src: "/opt/node/bin/{{ item }}"
    dest: "/usr/local/bin/{{ item }}"
    state: link
    force: yes
  loop:
    - node
    - npm
    - npx
    - corepack

- name: Set Node.js environment variables
  copy:
    dest: /etc/profile.d/node.sh
    content: |
      export PATH=/opt/node/bin:$PATH
    mode: '0644'

- name: Clean up Node.js download
  file:
    path: /tmp/node.tar.gz
    state: absent

- name: Verify Node.js installation
  command: /opt/node/bin/node --version
  register: node_version_output
  changed_when: false

- name: Display Node.js version
  debug:
    msg: "Node.js version: {{ node_version_output.stdout }}"

# Enable corepack for yarn/pnpm version management
- name: Enable corepack
  command: corepack enable
  changed_when: false
  ignore_errors: yes

# Install bun with integrity verification
- name: Install bun dependencies
  apk:
    name:
      - unzip
      - curl
      - gcompat
    state: present

- name: Create bun installation directory
  file:
    path: /opt/bun/bin
    state: directory
    mode: '0755'

- name: Download bun binary with integrity verification
  get_url:
    url: "{{ downloads.bun.binary['linux-aarch64'].url }}"
    dest: /tmp/bun.zip
    mode: '0644'
    checksum: "sha256:{{ downloads.bun.binary['linux-aarch64'].sha256 }}"

- name: Extract bun binary
  unarchive:
    src: /tmp/bun.zip
    dest: /tmp
    remote_src: yes

- name: Install bun binary
  copy:
    src: /tmp/bun-linux-aarch64/bun
    dest: /opt/bun/bin/bun
    mode: '0755'
    remote_src: yes

- name: Clean up bun download artifacts
  file:
    path: "{{ item }}"
    state: absent
  loop:
    - /tmp/bun.zip
    - /tmp/bun-linux-aarch64

- name: Create bun symlink
  file:
    src: /opt/bun/bin/bun
    dest: /usr/local/bin/bun
    state: link
    force: yes

- name: Create bunx symlink (bun provides bunx as an alias)
  file:
    src: /opt/bun/bin/bun
    dest: /usr/local/bin/bunx
    state: link
    force: yes
