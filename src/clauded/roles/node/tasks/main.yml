---
# Use nodejs-current from community which is built against compatible sqlite

- name: Remove any previous fnm installation
  file:
    path: "{{ item }}"
    state: absent
  loop:
    - /opt/fnm
    - /usr/local/bin/fnm
    - /usr/local/bin/node
    - /usr/local/bin/npm
    - /usr/local/bin/npx
  ignore_errors: yes

- name: Enable Alpine v3.21 community repository
  lineinfile:
    path: /etc/apk/repositories
    line: "https://dl-cdn.alpinelinux.org/alpine/v3.21/community"
    state: present

- name: Update apk cache
  apk:
    update_cache: yes

- name: Install nodejs-current and npm (has compatible sqlite)
  apk:
    name:
      - nodejs-current
      - npm
    state: present

- name: Verify Node.js installation
  command: node --version
  register: node_version_output
  changed_when: false

- name: Display Node.js version
  debug:
    msg: "Node.js version: {{ node_version_output.stdout }}"

# Enable corepack for yarn/pnpm version management
- name: Enable corepack
  command: corepack enable
  changed_when: false
  ignore_errors: yes

# Install bun
- name: Install bun dependencies
  apk:
    name:
      - unzip
      - curl
      - gcompat
    state: present

- name: Install bun
  shell: |
    curl -fsSL https://bun.sh/install | bash
  args:
    creates: /opt/bun/bin/bun
  environment:
    BUN_INSTALL: /opt/bun

- name: Create bun symlink
  file:
    src: /opt/bun/bin/bun
    dest: /usr/local/bin/bun
    state: link
    force: yes

- name: Create bunx symlink
  file:
    src: /opt/bun/bin/bunx
    dest: /usr/local/bin/bunx
    state: link
    force: yes
  ignore_errors: yes
