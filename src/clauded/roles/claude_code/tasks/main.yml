---
- name: Install Claude Code CLI
  npm:
    name: "@anthropic-ai/claude-code"
    global: yes

- name: Configure Claude Code to skip permission prompts
  copy:
    dest: /etc/profile.d/claude.sh
    content: |
      export CLAUDE_DANGEROUSLY_SKIP_PERMISSIONS=true
    mode: '0644'
  when: claude_dangerously_skip_permissions | default(false)

- name: Remove Claude skip permissions config when disabled
  file:
    path: /etc/profile.d/claude.sh
    state: absent
  when: not (claude_dangerously_skip_permissions | default(false))

- name: Verify Claude Code installation
  command: claude --version
  register: claude_version
  changed_when: false
  ignore_errors: yes

- name: Display Claude Code version
  debug:
    msg: "Claude Code version: {{ claude_version.stdout | default('installed') }}"
