---
# Install Playwright and browser dependencies on Ubuntu

- name: Install Playwright core system dependencies
  apt:
    name:
      - xvfb
      - libnss3
      - libfreetype6
      - libharfbuzz0b
      - fonts-freefont-ttf
      - fonts-noto
      - libstdc++6
      - libgl1-mesa-glx
      - libegl1-mesa
      - libxcomposite1
      - libxdamage1
      - libxrandr2
      - libxshmfence1
      - libatk1.0-0
      - at-spi2-core
      - libcups2
      - libdrm2
      - libdbus-1-3
      - libxkbcommon0
      - libpango-1.0-0
      - libcairo2
      - libasound2
      - libgbm1
    state: present
    update_cache: yes

# Install system browsers as fallback
- name: Install system Chromium
  apt:
    name: chromium-browser
    state: present
  when: "'chromium' in playwright_browsers"
  ignore_errors: yes

- name: Install system Firefox
  apt:
    name: firefox
    state: present
  when: "'firefox' in playwright_browsers"

# WebKit requires additional dependencies on Ubuntu
- name: Install WebKit dependencies
  apt:
    name:
      - libwoff1
      - libevent-2.1-7
      - libvpx7
      - libopus0
      - gstreamer1.0-plugins-base
      - gstreamer1.0-plugins-good
      - gstreamer1.0-plugins-bad
      - gstreamer1.0-libav
      - libsoup-3.0-0
      - libsecret-1-0
      - libmanette-0.2-0
      - libavif15
      - libjxl0.7
      - libenchant-2-2
      - libhyphen0
    state: present
  when: "'webkit' in playwright_browsers"
  ignore_errors: yes

# Install playwright globally via npm
- name: Install Playwright globally via npm
  command: npm install -g playwright @playwright/test
  register: playwright_npm_install
  changed_when: "'added' in playwright_npm_install.stdout or 'up to date' not in playwright_npm_install.stdout"

- name: Verify Playwright installation
  command: npx playwright --version
  register: playwright_version
  changed_when: false

- name: Display Playwright version
  debug:
    msg: "Playwright version: {{ playwright_version.stdout }}"

# Create browsers directory with proper permissions
- name: Create Playwright browsers directory
  file:
    path: /opt/playwright-browsers
    state: directory
    mode: '0777'

# Install selected Playwright browsers
- name: Install Playwright browsers
  command: "npx playwright install {{ playwright_browsers | join(' ') }}"
  environment:
    PLAYWRIGHT_BROWSERS_PATH: /opt/playwright-browsers
  register: browsers_install
  changed_when: "'Downloading' in browsers_install.stdout"
  when: playwright_browsers | length > 0

- name: Display installed browsers
  debug:
    msg: "Installed Playwright browsers: {{ playwright_browsers | join(', ') }}"
  when: playwright_browsers | length > 0

# Create Chrome compatibility symlinks
- name: Create Chrome compatibility directory
  file:
    path: /opt/google/chrome
    state: directory
    mode: '0755'
  when: "'chromium' in playwright_browsers"

- name: Create Chrome symlink for compatibility
  file:
    src: /usr/bin/chromium-browser
    dest: /opt/google/chrome/chrome
    state: link
  when: "'chromium' in playwright_browsers"
  ignore_errors: yes

# Set environment variables for Playwright
- name: Set Playwright environment variables
  copy:
    dest: /etc/profile.d/playwright.sh
    content: |
      export PLAYWRIGHT_BROWSERS_PATH=/opt/playwright-browsers
      export PLAYWRIGHT_CHROMIUM_EXECUTABLE_PATH=/usr/bin/chromium-browser
      export PLAYWRIGHT_FIREFOX_EXECUTABLE_PATH=/usr/bin/firefox
    mode: '0644'
