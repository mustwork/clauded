---
# Install Playwright and browser dependencies on Ubuntu

- name: Install Xvfb, X11/GTK libs, and D-Bus for display support
  apt:
    name:
      - xvfb
      - dbus-x11
      - libgtk-3-0t64
      - libatk-bridge2.0-0t64
    state: present
    update_cache: yes

# Install playwright globally via npm
- name: Install Playwright globally via npm
  command: npm install -g playwright @playwright/test
  register: playwright_npm_install
  changed_when: "'added' in playwright_npm_install.stdout or 'up to date' not in playwright_npm_install.stdout"

- name: Verify Playwright installation
  command: npx playwright --version
  register: playwright_version
  changed_when: false

- name: Display Playwright version
  debug:
    msg: "Playwright version: {{ playwright_version.stdout }}"

# Let Playwright install its own system dependencies (distro-version-aware)
- name: Install Playwright system dependencies
  command: npx playwright install-deps
  register: playwright_deps
  changed_when: "'Installing' in playwright_deps.stdout"

# Create browsers directory with proper permissions
- name: Create Playwright browsers directory
  file:
    path: /opt/playwright-browsers
    state: directory
    mode: '0777'

# Install selected Playwright browsers
- name: Install Playwright browsers
  command: "npx playwright install {{ playwright_browsers | join(' ') }}"
  environment:
    PLAYWRIGHT_BROWSERS_PATH: /opt/playwright-browsers
  register: browsers_install
  changed_when: "'Downloading' in browsers_install.stdout"
  when: playwright_browsers | length > 0

- name: Display installed browsers
  debug:
    msg: "Installed Playwright browsers: {{ playwright_browsers | join(', ') }}"
  when: playwright_browsers | length > 0

# Start Xvfb virtual display for headless GUI support
- name: Start Xvfb on display :99
  shell: |
    if ! pgrep -x Xvfb > /dev/null; then
      Xvfb :99 -screen 0 1280x1024x24 &
      sleep 1
    fi
  changed_when: false

# Set environment variables for Playwright
- name: Set Playwright environment variables
  copy:
    dest: /etc/profile.d/playwright.sh
    content: |
      export DISPLAY=:99
      export PLAYWRIGHT_BROWSERS_PATH=/opt/playwright-browsers
    mode: '0644'
