---
- name: Update apk cache
  apk:
    update_cache: yes

- name: Install common packages
  apk:
    name:
      - ca-certificates
      - coreutils
      - curl
      - direnv
      - git
      - gnupg
      - alpine-sdk
      - bash
      - shadow
      - sudo
      - openssh
    state: present

- name: Set bash as default shell for {{ ansible_user }}
  user:
    name: "{{ ansible_user }}"
    shell: /bin/bash

- name: Get actual remote username
  become: no
  command: whoami
  register: remote_whoami
  changed_when: false

- name: Get actual home directory
  become: no
  shell: echo $HOME
  register: remote_home
  changed_when: false

- name: Ensure home directory has correct ownership
  file:
    path: "{{ remote_home.stdout }}"
    state: directory
    owner: "{{ remote_whoami.stdout }}"
    group: "{{ remote_whoami.stdout }}"
    mode: '0755'

- name: Set bash as default shell for root
  user:
    name: root
    shell: /bin/bash
