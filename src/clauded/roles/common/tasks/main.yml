---
- name: Update apk cache
  apk:
    update_cache: yes

- name: Install common packages
  apk:
    name:
      - ca-certificates
      - coreutils
      - curl
      - direnv
      - git
      - gnupg
      - alpine-sdk
      - bash
      - shadow
      - sudo
      - openssh
    state: present

- name: Set bash as default shell for {{ ansible_user }}
  user:
    name: "{{ ansible_user }}"
    shell: /bin/bash

- name: Get actual remote username
  become: no
  command: whoami
  register: remote_whoami
  changed_when: false

- name: Get actual home directory
  become: no
  shell: echo $HOME
  register: remote_home
  changed_when: false

- name: Ensure home directory has correct ownership
  file:
    path: "{{ remote_home.stdout }}"
    state: directory
    owner: "{{ remote_whoami.stdout }}"
    group: "{{ remote_whoami.stdout }}"
    mode: '0755'

- name: Copy host .gitconfig to VM
  copy:
    dest: "{{ remote_home.stdout }}/.gitconfig"
    content: "{{ gitconfig_content }}"
    owner: "{{ remote_whoami.stdout }}"
    group: "{{ remote_whoami.stdout }}"
    mode: '0644'
  when: gitconfig_content | length > 0

- name: Set bash as default shell for root
  user:
    name: root
    shell: /bin/bash

- name: Store clauded metadata
  copy:
    dest: /etc/clauded.json
    content: |
      {
        "project_name": "{{ clauded_project_name }}",
        "version": "{{ clauded_version }}",
        "commit": "{{ clauded_commit }}",
        "provisioned": "{{ clauded_provision_timestamp }}"
      }
    mode: '0644'

- name: Create clauded welcome message script
  copy:
    dest: /etc/profile.d/00-clauded-welcome.sh
    content: |
      # clauded VM welcome message
      if [ -t 1 ] && [ -z "$CLAUDED_WELCOME_SHOWN" ]; then
        export CLAUDED_WELCOME_SHOWN=1
        echo ""
        echo "  {{ clauded_project_name }} | clauded v{{ clauded_version }} ({{ clauded_commit }})"
        echo "  Provisioned: {{ clauded_provision_timestamp }}"
        echo ""
      fi
    mode: '0644'
