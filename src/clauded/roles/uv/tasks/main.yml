---
- name: Install curl for uv download
  apk:
    name: curl
    state: present

- name: Download uv installer script via HTTPS
  get_url:
    url: "{{ downloads.uv.installer_url }}"
    dest: /tmp/uv-install.sh
    mode: '0755'

- name: Install uv (Python package manager)
  command: /tmp/uv-install.sh
  args:
    creates: /usr/local/bin/uv
  environment:
    UV_INSTALL_DIR: /usr/local/bin

- name: Clean up uv installer
  file:
    path: /tmp/uv-install.sh
    state: absent

- name: Verify uv installation
  command: uv --version
  register: uv_version_output
  changed_when: false

- name: Display uv version
  debug:
    msg: "uv version: {{ uv_version_output.stdout }}"

# Check if running on Alpine (musl) - uv doesn't support musl Python distributions yet
# See: https://github.com/astral-sh/uv/issues/6890
- name: Check for Alpine Linux
  stat:
    path: /etc/alpine-release
  register: alpine_check

# On non-Alpine systems: Install Python via uv
- name: Install Python {{ python_version }} via uv
  command: uv python install {{ python_version }}
  register: uv_python_install
  changed_when: "'Installed' in uv_python_install.stderr or 'Installed' in uv_python_install.stdout"
  when: not alpine_check.stat.exists

- name: Find uv-installed Python binary path
  shell: uv python find {{ python_version }}
  register: python_path
  changed_when: false
  when: not alpine_check.stat.exists

- name: Create python symlink to uv-managed Python
  file:
    src: "{{ python_path.stdout | trim }}"
    dest: /usr/local/bin/python
    state: link
    force: yes
  when: not alpine_check.stat.exists

- name: Create python3 symlink to uv-managed Python
  file:
    src: "{{ python_path.stdout | trim }}"
    dest: /usr/local/bin/python3
    state: link
    force: yes
  when: not alpine_check.stat.exists

# On Alpine systems: Use system Python (installed by python role via apk)
- name: Find system Python path on Alpine
  command: which python3
  register: alpine_python_path
  changed_when: false
  when: alpine_check.stat.exists

- name: Create python symlink to system Python on Alpine
  file:
    src: "{{ alpine_python_path.stdout | trim }}"
    dest: /usr/local/bin/python
    state: link
    force: yes
  when: alpine_check.stat.exists

- name: Note Alpine Python limitation
  debug:
    msg: "Using system Python on Alpine (uv python install not supported on musl)"
  when: alpine_check.stat.exists

# Environment configuration (both platforms)
- name: Set UV_PYTHON_PREFERENCE environment variable
  copy:
    dest: /etc/profile.d/uv-python.sh
    content: |
      export UV_PYTHON_PREFERENCE={{ 'only-system' if alpine_check.stat.exists else 'managed' }}
      export PATH=/usr/local/bin:$PATH
    mode: '0644'

- name: Verify Python version
  command: /usr/local/bin/python --version
  register: python_version_output
  changed_when: false

- name: Display Python version
  debug:
    msg: "Python version: {{ python_version_output.stdout }}"
